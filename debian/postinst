#!/bin/sh
# bashsupport disable=BP5007
# postinst script for pengwin-base
#
# see: dh_installdeb(1)

set -e

# summary of how this script can be called:
#        * <postinst> `configure' <most-recently-configured-version>
#        * <old-postinst> `abort-upgrade' <new version>
#        * <conflictor's-postinst> `abort-remove' `in-favour' <package>
#          <new-version>
#        * <postinst> `abort-remove'
#        * <deconfigured's-postinst> `abort-deconfigure' `in-favour'
#          <failed-install-package> <version> `removing'
#          <conflicting-package> <version>
# for details, see https://www.debian.org/doc/debian-policy/ or
# the debian-policy package

TMPDIR="/run/dpkg.pengwin-base.inst"
#FLAGFILE="/etc/apt/.dist-upgrade"
case "$1" in
	configure)
		if [ -f "${TMPDIR}/profile" ] ; then
			echo "Backing up old profile to /etc/profile.old"
			mv "/etc/profile" "/etc/profile.old"
			echo "Moving new profile into /etc"
			mv "${TMPDIR}/profile" /etc
		fi

		if [ -f "${TMPDIR}/sudoers" ] ; then
			echo "Backup up old sudoers to /etc/sudoers.old"
			mv "/etc/sudoers" "/etc/sudoers.old"
			echo "Moving new sudoers into /etc"
			mv "${TMPDIR}/sudoers" /etc
		fi

		if [ -f "${TMPDIR}/sudoers.lecture" ] ; then
			echo "Moving new sudoers.lecture into /etc"
			mv "${TMPDIR}/sudoers.lecture" /etc
		fi

		echo "Symlinking /etc/dpkg/origins/pengwin to default"
		ln -sf /etc/dpkg/origins/pengwin /etc/dpkg/origins/default

		### Whitewater Foundry GPG Key install
		echo "Installing Whitewater Foundry GPG keys..."

		setup_gpgkey="https://packagecloud.io/whitewaterfoundry/pengwin-setup/gpgkey"
		base_gpgkey="https://packagecloud.io/whitewaterfoundry/pengwin-base/gpgkey"
		wslu_gpgkey="https://packagecloud.io/whitewaterfoundry/wslu/gpgkey"

		keyrings_path="/etc/apt/keyrings"
    mkdir -p "${keyrings_path}"

		setup_gpgkey_file="${keyrings_path}/whitewaterfoundry_pengwin-base-archive-keyring.gpg"
		base_gpgkey_file="${keyrings_path}/whitewaterfoundry_pengwin-setup-archive-keyring.gpg"
		wslu_gpgkey_file="${keyrings_path}/whitewaterfoundry_wslu-archive-keyring.gpg"

		curl -fsSL "${base_gpgkey}" 	 | gpg --dearmor >"${setup_gpgkey_file}" 2>/dev/null && chmod 0644 "${setup_gpgkey_file}"
		curl -fsSL "${setup_gpgkey}"	 | gpg --dearmor >"${base_gpgkey_file}" 2>/dev/null && chmod 0644 "${base_gpgkey_file}"
		curl -fsSL "${wslu_gpgkey}"	   | gpg --dearmor >"${wslu_gpgkey_file}" 2>/dev/null && chmod 0644 "${wslu_gpgkey_file}"

		chmod 755 /usr/local/bin/cmd-exe
		chmod 755 /usr/local/bin/legacy_wslupath
		chmod 755 /usr/local/bin/wsl_change_checker
		chmod 755 /usr/local/bin/libgl-change-checker
		chmod 755 /usr/local/bin/switch2dev
		chmod 755 /usr/local/bin/switch2next
		chmod 755 /usr/local/bin/pengwin-help
		chmod 755 /usr/local/bin/winpwsh-exe
		chmod 755 /usr/local/bin/winpwsh-int-exe
		chmod 755 /usr/local/bin/wslsystemctl
		chmod 755 /usr/local/bin/wsljournalctl
		chmod 755 /usr/local/bin/start-systemd
    chmod 755 /usr/local/bin/check_x11_socket

		chmod u+s "$(command -v ping)"

		echo "%sudo   ALL=NOPASSWD: /usr/local/bin/wsl_change_checker" | EDITOR='tee' visudo --quiet --file=/etc/sudoers.d/pengwin-wsl-profile
		echo "%sudo   ALL=NOPASSWD: /usr/local/bin/libgl-change-checker" | EDITOR='tee -a' visudo --quiet --file=/etc/sudoers.d/pengwin-wsl-profile
		echo "%sudo   ALL=NOPASSWD: /usr/local/bin/check_x11_socket" | EDITOR='tee -a' visudo --quiet --file=/etc/sudoers.d/pengwin-wsl-profile

		echo "adding permission of execution to scripts into update-motd.d folder"
		chmod +x /etc/update-motd.d/00-header
		chmod +x /etc/update-motd.d/20-help
		chmod +x /etc/update-motd.d/30-pengwin-setup
		chmod +x /etc/update-motd.d/40-environment

		echo " Done!"
		###

		# Remove temporary directory
		echo "Cleaning up pengwin-base temporary install dir"
		rm -rf ${TMPDIR}

		# This is a new install, create dist-upgrade flag file
		# touch "${FLAGFILE}"
	;;

	abort-upgrade|abort-remove|abort-deconfigure)
		# Silent, as this directory may not exist
		# echo "Cleaning up pengwin-base temporary install dir"
		rm -rf ${TMPDIR}
	;;

	*)
		echo "postinst called with unknown argument \`$1'" >&2
		exit 1
	;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
